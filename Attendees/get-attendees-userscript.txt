// You need to go to the event page, let it load and then hit refresh for this script to run.
// You can then hit the "Download Attendees CSV" button that appears in the bottom-left of the window to download a csv file with all the current attendees.

// ==UserScript==
// @name         Live Attendees CSV (Names Only)
// @namespace    http://tampermonkey.net/
// @version      2.1
// @description  Scrape attendee names dynamically and download CSV manually
// @match        https://biketerra.com/events*
// @grant        none
// ==/UserScript==

(function () {
    "use strict";

    const recorded = new Set(); // store unique attendee names

    function waitForGrid(callback) {
        const grid = document.querySelector(".event-grid");
        if (grid) {
            callback(grid);
        } else {
            const observer = new MutationObserver((mutations, obs) => {
                const grid = document.querySelector(".event-grid");
                if (grid) {
                    obs.disconnect();
                    callback(grid);
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });
        }
    }

    function scrapeAttendees() {
        const newAttendees = [];
        const grid = document.querySelector(".event-grid");
        if (!grid) return newAttendees;

        const labels = grid.querySelectorAll(".event-label");
        const values = grid.querySelectorAll(".event-value");

        for (let i = 0; i < labels.length; i++) {
            const labelText = labels[i].textContent.trim();
            if (labelText.startsWith("Attendees")) {
                const valueBlock = values[i];
                const tagItems = valueBlock.querySelectorAll(".tag-item");
                tagItems.forEach(tag => {
                    const name = tag.textContent.trim();
                    if (!recorded.has(name)) {
                        recorded.add(name);
                        newAttendees.push(name);
                    }
                });
                break;
            }
        }

        if (newAttendees.length > 0) {
            console.log(`New attendees detected: ${newAttendees.join(", ")}`);
        }

        return newAttendees;
    }

    function generateCSV() {
        if (!recorded.size) {
            alert("No attendees to download.");
            return "";
        }

        let csv = "Name\n";
        recorded.forEach(name => {
            csv += `"${name}"\n`;
        });

        return csv;
    }

    function downloadCSV() {
        const csv = generateCSV();
        if (!csv) return;

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "attendees.csv";
        a.click();

        URL.revokeObjectURL(url);
    }

    // Wait for the grid to exist, then scrape and observe changes
    waitForGrid((grid) => {
        scrapeAttendees();

        const observer = new MutationObserver(() => scrapeAttendees());
        observer.observe(grid, { childList: true, subtree: true });
    });

    // Add the floating "Download CSV" button
    const btn = document.createElement("button");
    btn.textContent = "Download Attendees CSV";
    btn.style.position = "fixed";
    btn.style.bottom = "20px";
    btn.style.right = "20px";
    btn.style.zIndex = "9999";
    btn.style.padding = "10px 15px";
    btn.style.backgroundColor = "#007bff";
    btn.style.color = "#fff";
    btn.style.border = "none";
    btn.style.borderRadius = "5px";
    btn.style.cursor = "pointer";
    btn.addEventListener("click", downloadCSV);
    document.body.appendChild(btn);

})();
