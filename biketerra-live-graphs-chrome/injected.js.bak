(function(){
  const UPDATE_INTERVAL=500; // ms
  const intervalSec = UPDATE_INTERVAL / 1000; // 0.5 sek
  let fullDataPower=[], fullDataHR=[], fullDataCad=[], fullDataSpeed=[];
  let ftp=250;
  let statsHiddenByUser=false;
  const ridersData={};

  let maxPoints = Math.round(120 / intervalSec); // huvudgraf start = 120 sek
  const ridersMaxPoints = Math.round(30 / intervalSec); // riders graf alltid 30 sek
  let maxSinceStart = { power: 0, hr: 0, cad: 0, speed: 0 };

  const savedFTP=localStorage.getItem('overlayFTP'); if(savedFTP) ftp=parseFloat(savedFTP);

  function getPower(){const row=document.querySelector('.stat-row.name-power .stat-value.monospace'); if(!row) return null; const val=parseFloat(row.textContent); return isNaN(val)?null:val;}
  function getHR(){const row=document.querySelector('.stat-row .ico-hr')?.closest('.stat-row')?.querySelector('.stat-value.monospace'); if(!row) return null; const val=parseFloat(row.textContent); return isNaN(val)?null:val;}
  function getCadence(){const row=document.querySelector('.stat-row .ico-cadence')?.closest('.stat-row')?.querySelector('.stat-value.monospace'); if(!row) return null; const val=parseFloat(row.textContent); return isNaN(val)?null:val;}
  function getSpeed(){const rows=document.querySelectorAll('.stat-row'); for(const row of rows){const lbl=row.querySelector('.stat-label'); if(lbl&&lbl.textContent.trim()==='kph'){const val=parseFloat(row.querySelector('.stat-value.monospace').textContent); return isNaN(val)?null:val;}} return null;}
  function getPowerColor(value){
    if(value==null) return 'rgba(255,255,255,0.2)';
    const pct=value/ftp;
    if(pct<0.6) return '#808080';
    if(pct<0.76) return '#0070FF';
    if(pct<0.90) return '#00C000';
    if(pct<1.05) return '#FFFF00';
    if(pct<1.18) return '#FF8000';
    return '#FF0000';
  }

  // ===== Overlay: Huvud =====
  const overlay=document.createElement('div');
  overlay.style.cssText=`position:fixed; width:650px; height:250px; min-width:200px; min-height:150px; max-width:800px; max-height:600px; background:rgba(0,0,0,0.7); color:white; z-index:9999; padding:10px; border-radius:12px; box-sizing:border-box; resize:both; cursor:move; display:flex; flex-direction:column; font-family:sans-serif; font-size:14px;`;
  const statsDiv=document.createElement('div'); statsDiv.style.cssText='color:#888; margin-bottom:6px; font-size:13px;'; overlay.appendChild(statsDiv);
  const canvas=document.createElement('canvas'); canvas.id='chart'; canvas.style.flex='1 1 auto'; overlay.appendChild(canvas);

  // ===== Controls =====
  const controlsDiv=document.createElement('div');
  controlsDiv.style.cssText='position:absolute; top:8px; right:40px; background:rgba(0,0,0,0.5); padding:4px 8px; border-radius:8px; display:none; align-items:center; gap:10px;';

  const resetBtn=document.createElement('button'); resetBtn.textContent='Reset Data';
  Object.assign(resetBtn.style,{padding:'2px 6px',border:'none',borderRadius:'6px',background:'rgba(255,255,255,0.2)',color:'white',cursor:'pointer',fontSize:'12px'});
  resetBtn.addEventListener('click',()=>{
    fullDataPower=[]; fullDataHR=[]; fullDataCad=[]; fullDataSpeed=[];
    for(const k in ridersData) ridersData[k]=[];
    maxSinceStart = { power: 0, hr: 0, cad: 0, speed: 0 };
    simState = { power: ftp*0.5, hr: 100, cad: 80, speed: 25 };
    for(const rider in simRidersState) simRidersState[rider] = 3 + Math.random()*2;
  });
  controlsDiv.appendChild(resetBtn);

  const simBtn=document.createElement('button'); simBtn.textContent='Simulate';
  Object.assign(simBtn.style,{padding:'2px 6px',border:'none',borderRadius:'6px',background:'rgba(255,255,255,0.2)',color:'white',cursor:'pointer',fontSize:'12px'});
  controlsDiv.appendChild(simBtn);

  let sim=false, simInterval=null;
  simBtn.addEventListener('click',()=>{
    sim=!sim;
    if(sim){simBtn.textContent='Stop Sim'; simInterval=setInterval(simulateData,UPDATE_INTERVAL);}
    else{simBtn.textContent='Simulate'; clearInterval(simInterval); simInterval=null;}
  });

  const hideSideBtn=document.createElement('button'); hideSideBtn.textContent='Hide Side';
  Object.assign(hideSideBtn.style,{padding:'2px 6px',border:'none',borderRadius:'6px',background:'rgba(255,255,255,0.2)',color:'white',cursor:'pointer',fontSize:'12px'});
  controlsDiv.appendChild(hideSideBtn);

  const timeSelect=document.createElement('select');
  [{label:'60 sec',value:60},{label:'3 min',value:180},{label:'5 min',value:300},{label:'20 min',value:1200},{label:'60 min',value:3600}].forEach(o=>{
    const el=document.createElement('option'); el.textContent=o.label; el.value=o.value; timeSelect.appendChild(el);
  });
  controlsDiv.appendChild(timeSelect);

  const ftpLabel=document.createElement('label'); ftpLabel.textContent='FTP:'; controlsDiv.appendChild(ftpLabel);
  const ftpInput=document.createElement('input'); ftpInput.type='number'; ftpInput.value=ftp; ftpInput.style.width='60px'; controlsDiv.appendChild(ftpInput);
  ftpInput.addEventListener('change',()=>{ const val=parseFloat(ftpInput.value); if(!isNaN(val)&&val>0){ftp=val; localStorage.setItem('overlayFTP',ftp);}});

  overlay.appendChild(controlsDiv);

  const toggleBtn=document.createElement('button'); toggleBtn.textContent='≡';
  Object.assign(toggleBtn.style,{position:'absolute',top:'8px',right:'8px',padding:'2px 6px',border:'none',borderRadius:'6px',background:'rgba(255,255,255,0.2)',color:'white',fontWeight:'bold',cursor:'pointer',zIndex:10000});
  overlay.appendChild(toggleBtn);
  document.body.appendChild(overlay);
  toggleBtn.addEventListener('click',()=>{controlsDiv.style.display=(controlsDiv.style.display==='none')?'flex':'none';});

  // ===== Overlay: Maxvärde =====
  const statsOverlay=document.createElement('div');
  statsOverlay.style.cssText='position:fixed; width:260px; background:rgba(0,0,0,0.7); color:white; z-index:9999; padding:8px 10px; border-radius:12px; box-sizing:border-box; font-family:sans-serif; font-size:14px; display:flex; flex-direction:column; gap:4px; justify-content:center; align-items:flex-start; box-shadow:0 2px 8px rgba(0,0,0,0.5);';
  const statsTable=document.createElement('div'); statsOverlay.appendChild(statsTable); document.body.appendChild(statsOverlay);

  // ===== Overlay: Ryttare =====
  const ridersOverlay=document.createElement('div');
  ridersOverlay.style.cssText='position:fixed; width:400px; height:250px; background:rgba(0,0,0,0.7); color:white; z-index:9999; padding:10px; border-radius:12px; box-sizing:border-box; font-family:sans-serif; font-size:12px; display:flex; flex-direction:column;';

  const ridersCanvas=document.createElement('canvas');
  ridersCanvas.style.flex = '1 1 auto';
  ridersOverlay.appendChild(ridersCanvas);

  const ridersTitle = document.createElement('div');
  ridersTitle.textContent = 'W/kg last 30sec';
  ridersTitle.style.cssText = 'font-weight:bold; margin-top:6px; color:#ccc; font-size:13px; text-align:center;';
  ridersOverlay.appendChild(ridersTitle);

  document.body.appendChild(ridersOverlay);

  makeDraggable(overlay,'overlay');
  makeDraggable(statsOverlay,'statsOverlay');
  makeDraggable(ridersOverlay,'ridersOverlay');

  function makeDraggable(el,storageKey){
    let dragging=false, offsetX=0, offsetY=0;
    const savedLeft = localStorage.getItem(storageKey+'Left');
    const savedTop = localStorage.getItem(storageKey+'Top');
    if(savedLeft && savedTop){ el.style.left=savedLeft+'px'; el.style.top=savedTop+'px'; el.style.right='auto'; el.style.bottom='auto'; } 
    else { el.style.left='12px'; el.style.top='12px'; }
    el.addEventListener('mousedown',e=>{if(e.target===el){dragging=true; offsetX=e.clientX-el.offsetLeft; offsetY=e.clientY-el.offsetTop; el.style.cursor='grabbing'; e.preventDefault();}});
    document.addEventListener('mousemove',e=>{if(dragging){el.style.left=(e.clientX-offsetX)+'px'; el.style.top=(e.clientY-offsetY)+'px'; el.style.right='auto'; el.style.bottom='auto';}});
    document.addEventListener('mouseup',()=>{if(dragging){dragging=false; el.style.cursor='default'; localStorage.setItem(storageKey+'Left',el.offsetLeft); localStorage.setItem(storageKey+'Top',el.offsetTop);}});
  }

  hideSideBtn.addEventListener('click',()=>{
    const newDisplay=(statsOverlay.style.display!=='none')?'none':'flex';
    statsOverlay.style.display=newDisplay;
    ridersOverlay.style.display=newDisplay;
    hideSideBtn.textContent=(newDisplay==='none')?'Show Side':'Hide Side';
    statsHiddenByUser=(newDisplay==='none');
  });

  // ===== Simulation =====
  let simState = { power: ftp*0.5, hr: 100, cad: 80, speed: 25 };
  const simRidersState = { 'Test': 3 + Math.random()*2 };

  function simulateData(){
    simState.power += (Math.random()-0.5)*20; simState.power=Math.max(0,Math.min(ftp*1.2,simState.power));
    simState.hr += (Math.random()-0.5)*3; simState.hr=Math.max(60,Math.min(200,simState.hr));
    simState.cad += (Math.random()-0.5)*2; simState.cad=Math.max(0,Math.min(150,simState.cad));
    simState.speed += (Math.random()-0.5)*4; simState.speed=Math.max(0,Math.min(60,simState.speed));

    fullDataPower.push(Math.round(simState.power));
    fullDataHR.push(Math.round(simState.hr));
    fullDataCad.push(Math.round(simState.cad));
    fullDataSpeed.push(Math.round(simState.speed));
    if(fullDataPower.length>maxPoints) fullDataPower.shift();
    if(fullDataHR.length>maxPoints) fullDataHR.shift();
    if(fullDataCad.length>maxPoints) fullDataCad.shift();
    if(fullDataSpeed.length>maxPoints) fullDataSpeed.shift();

    // Riders graf
    for(const riderName of Object.keys(simRidersState)){
        let wkg = simRidersState[riderName];
        wkg += (Math.random()-0.5)*0.2; wkg=Math.max(1,Math.min(10,wkg));
        simRidersState[riderName] = wkg;
        if(!ridersData[riderName]) ridersData[riderName]=[];
        ridersData[riderName].push(Math.round(wkg*10)/10);
        if(ridersData[riderName].length>ridersMaxPoints) ridersData[riderName].shift();
    }

    maxSinceStart.power = Math.max(maxSinceStart.power, Math.round(simState.power));
    maxSinceStart.hr = Math.max(maxSinceStart.hr, Math.round(simState.hr));
    maxSinceStart.cad = Math.max(maxSinceStart.cad, Math.round(simState.cad));
    maxSinceStart.speed = Math.max(maxSinceStart.speed, Math.round(simState.speed));
  }

  // ===== Chart.js =====
  let chart,ridersChart;
  loadChart(()=>{
    const ctx=canvas.getContext('2d');
    chart=new Chart(ctx,{type:'line',data:{labels:Array.from({length:maxPoints},(_,i)=>i-maxPoints+1),datasets:[
      {label:'HR',data:fullDataHR,borderColor:'red',fill:false,tension:0.25,pointRadius:0},
      {label:'Cadence',data:fullDataCad,borderColor:'#00ffff',fill:false,tension:0.25,pointRadius:0},
      {label:'Speed',data:fullDataSpeed,borderColor:'orange',fill:false,tension:0.25,pointRadius:0},
      {label:'Power',data:fullDataPower,borderColor:ctx=>getPowerColor(ctx.raw),backgroundColor:ctx=>getPowerColor(ctx.raw).replace(')',',0.3)'),fill:true,tension:0.25,pointRadius:0,segment:{borderColor:ctx=>getPowerColor(ctx.p0.parsed.y),backgroundColor:ctx=>getPowerColor(ctx.p0.parsed.y).replace(')',',0.3)')}}]},
      options:{animation:false,responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,labels:{font:{size:10},color:'#aaa'}}},layout:{padding:{left:10,right:10,top:5,bottom:20}},scales:{x:{display:false,offset:true},y:{beginAtZero:true,ticks:{color:'#777'}}}}});

    const rctx=ridersCanvas.getContext('2d');
    ridersChart=new Chart(rctx,{type:'line',data:{labels:Array.from({length:ridersMaxPoints},(_,i)=>i-ridersMaxPoints+1),datasets:[]},options:{animation:false,responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,labels:{font:{size:10},color:'#aaa'}}},scales:{x:{display:false},y:{beginAtZero:true,ticks:{color:'#777'}}}}});

    setInterval(updateAll,UPDATE_INTERVAL);
  });

  function updateAll(){
    if(!sim){
      const newPower=getPower(), newHR=getHR(), newCad=getCadence(), newSpeed=getSpeed();
      fullDataPower.push(newPower); fullDataHR.push(newHR); fullDataCad.push(newCad); fullDataSpeed.push(newSpeed);
      if(fullDataPower.length>maxPoints) fullDataPower.shift();
      if(fullDataHR.length>maxPoints) fullDataHR.shift();
      if(fullDataCad.length>maxPoints) fullDataCad.shift();
      if(fullDataSpeed.length>maxPoints) fullDataSpeed.shift();

      if(newPower!=null) maxSinceStart.power = Math.max(maxSinceStart.power,newPower);
      if(newHR!=null) maxSinceStart.hr = Math.max(maxSinceStart.hr,newHR);
      if(newCad!=null) maxSinceStart.cad = Math.max(maxSinceStart.cad,newCad);
      if(newSpeed!=null) maxSinceStart.speed = Math.max(maxSinceStart.speed,newSpeed);

      const riders=document.querySelectorAll('.riders-main .rider');
      riders.forEach(r=>{
        const name=r.querySelector('.rider-name')?.textContent?.trim();
        const wkgStr=r.querySelector('.rider-stats .rider-stat-value')?.textContent;
        if(!name || !wkgStr) return;
        const wkg=parseFloat(wkgStr);
        if(isNaN(wkg)) return;
        if(!ridersData[name]) ridersData[name]=[];
        ridersData[name].push(wkg);
        if(ridersData[name].length>ridersMaxPoints) ridersData[name].shift();
      });
    } else simulateData();

    // overlay alltid synlig
    overlay.style.display='flex';
    if(!statsHiddenByUser){ statsOverlay.style.display='flex'; ridersOverlay.style.display='flex'; }

    chart.data.datasets[0].data=fullDataHR.slice(-maxPoints);
    chart.data.datasets[1].data=fullDataCad.slice(-maxPoints);
    chart.data.datasets[2].data=fullDataSpeed.slice(-maxPoints);
    chart.data.datasets[3].data=fullDataPower.slice(-maxPoints);
    chart.update('none');

    const datasets=Object.entries(ridersData).filter(([k,v])=>v.length).map(([name,data],idx)=>({label:name,data:data.slice(-ridersMaxPoints),borderColor:['#FF0000','#00FF00','#0070FF','#FFFF00','#FF8000','#00FFFF','#FF00FF','#C0C0C0','#FFA500','#800080'][idx%10],fill:false,tension:0.25,pointRadius:0}));
    ridersChart.data.datasets=datasets;
    ridersChart.update('none');

    updatePowerStats(); updateMaxStats();
  }

  function calcAvg(data,sec){if(!data.length) return 0; const slice=data.slice(-Math.round(sec/intervalSec)); const vals=slice.filter(v=>v!=null); if(!vals.length) return 0; return Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);}
  function calcTSS(data,ftp){if(!data.length) return 0; const valid=data.filter(v=>v!=null); if(!valid.length) return 0; const avg=valid.reduce((a,b)=>a+b,0)/valid.length; return Math.round((avg/ftp)**2*valid.length/3600*100);}
  function updatePowerStats(){const p3=calcAvg(fullDataPower,3); const p60=calcAvg(fullDataPower,60); const p300=calcAvg(fullDataPower,300); const p1200=calcAvg(fullDataPower,1200); const p3600=calcAvg(fullDataPower,3600); statsDiv.textContent=`Power 3s:${p3} | 1min:${p60} | 5min:${p300} | 20min:${p1200} | 60min:${p3600}`;}
  function updateMaxStats(){const tss=calcTSS(fullDataPower,ftp); statsTable.innerHTML=`Max Power: ${maxSinceStart.power||0}<br>Max HR: ${maxSinceStart.hr||0}<br>Max Cadence: ${maxSinceStart.cad||0}<br>Max Speed: ${maxSinceStart.speed||0}<br>TSS: ${tss}`;}

  timeSelect.addEventListener('change', () => {
    const sec = parseInt(timeSelect.value);
    maxPoints = Math.round(sec*2/intervalSec); // dubblad tid
    if(chart){
      chart.data.labels = Array.from({ length: maxPoints }, (_, i) => i - maxPoints + 1);
      chart.update('none');
    }
  });

  function loadChart(cb){if(window.Chart) return cb(); const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js'; s.onload=cb; document.head.appendChild(s);}
})();
